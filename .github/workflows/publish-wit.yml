name: Publish WIT to registry

on:
  workflow_dispatch:

jobs:
  publish-wit:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      packages: write
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Rust to build wkg
        uses: ./.github/actions/spin-ci-dependencies
        with:
          rust: true

      - name: Install wasm-tools
        shell: bash
        run: cargo install wasm-tools

      - name: Install wkg
        shell: bash
        run: cargo install wkg --git https://github.com/itowlson/wasm-pkg-tools --branch docker-credential-does-not-play-nice-with-schemeful-urls

      - name: Login to the GitHub registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: spinframeworkbot
          password: ${{ secrets.SPIN_WIT_PAT }}

      - name: Build and publish WIT package
        shell: bash
        run: ./scripts/build-and-publish-wit.sh

